\documentclass[12pt]{extarticle}
% Using the geometry package with a small
% page size to create the article graphic
\usepackage[
   paper=a4paper,
   top=20mm,
   bottom=20mm,
   left=25mm,
   right=25mm
]{geometry}

%\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}
\usepackage{indentfirst} % русский стиль: отступ первого абзаца раздела
\usepackage{fontspec}
\setmainfont{CMU Serif}
\setsansfont{CMU Sans Serif}
\newfontfamily\russianfonttt{Courier New}
\newfontfamily\cyrillicfonttt{Courier New}
\setmonofont[Scale=0.8]{Courier New}
\usepackage{soul}

\usepackage{amsmath}

\usepackage{pgfplots}
\pgfplotsset{compat=1.15}
\usepackage{mathrsfs}
\usetikzlibrary{arrows}

\usepackage{amssymb}

\usepackage{hyperref}
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    filecolor=magenta,      
    urlcolor=cyan
}

\usepackage{amsfonts}
\usepackage{graphicx} % Для включения картинок, более продвинутый пакет, чем graphics
\usepackage{wrapfig} % Для размещения картинки сбоку от текста
\usepackage{array}

\usepackage[siunitx]{circuitikz}

\usetikzlibrary{circuits}
\usetikzlibrary{circuits.ee}
\usetikzlibrary{circuits.ee.IEC}
\usetikzlibrary{circuits.logic.IEC}

\usetikzlibrary{shapes}
\usetikzlibrary{arrows}
\usetikzlibrary{decorations.pathreplacing,decorations.pathmorphing}

\usepackage{caption}


\usepackage{xcolor} % to access the named colour LightGray
\definecolor{LightGray}{gray}{0.9}

\usepackage{minted}
%shell-session
\setminted[shell-session]{
	frame=lines,
	breaklines,
	framesep=1mm,
	baselinestretch=1.1,
	bgcolor=LightGray,
	fontsize=\footnotesize
}

\title{Цифровой термометр}
\date{Август 2024}
\author{Максим Хусаинов}

\begin{document}

\maketitle

\section{Описание}
Цифровой термометр состоит из двух частей, устройство, или прибор, и сервис HTTP. Устройство «разговаривает» с сервисом посредством запросов HTTP, передавая на сервис текущую температуру. Сервис собирает и сохраняет данные: время и температуру.

Прибор содержит экран, кнопку и датчик температуры. Датчик температуры подключается к прибору через провод. Сервис находится на сервере и имеет доступ к системе архивов.

При включении цифрового термометра, прибор каждую секунду считывает температуру с датчика температуры и отображает её на экране. Также прибор подключается к беспроводной сети. При нажатии на кнопку, начинается опыт: прибор отправляет запрос на сервис о начале опыта и в дальнейшем отправляет ежесекундно запросы с текущей температурой. Повторное нажатие на кнопку останавливает опыт, т.~е. прибор перестаёт посылать запросы на сервис с текущей температурой.

Сервис, при запросе о начале опыта, создает новый архив. При запросе с температурой, сервис сохраняет её вместе со временем получения запроса в созданный архив.

Датчик температуры работает в диапазоне от $-55^{\circ}$C до $125^{\circ}$C. Точность $\pm 0{,}5^{\circ}$C в диапазоне $-10^{\circ}$C до $85^{\circ}$C. 
Среднее потребление прибора $0{,}07$ А или $0{,}23$ Вт.

Далее документ содержит четыре раздела. В разделе \ref{Устройство}~«Устройство» описывается прибор и делится на два подраздела. В подразделе \ref{Материальная часть}~«Материальная часть» дается детальный разбор составных частей прибора и схема их соединений. Дополнительно, в подподразделе \ref{Аккумуляторный блок питания}~«Аккумуляторный блок питания» предоставляется вариант автономии устройства в плане энергии. В подразделе \ref{Программная часть}~«Программная часть» описывается алгоритм работы прибора и прилагается блок-схема этого алгоритма. В раздел \ref{Сервис HTTP}~«Сервис HTTP» описывается алгоритм работы сервера. В разделе \ref{Установка}~«Установка» даются инструкции по установке программной части прибора и сервиса. В подразделе \ref{Прошивка прибора}~«Прошивка прибора» содержится инструкция по прошивке прибора и в подразделе \ref{Запуск сервиса}~«Запуск сервиса» инструкция по запуску сервиса. В разделе \ref{Заключение}~«Заключение» приводятся возможный вариант использования прибора, а также некоторые идеи для его усовершенствования.

\section{Устройство}\label{Устройство}

\subsection{Материальная часть}\label{Материальная часть}
Прибор цифрового термометра состоит из следующих составных частей, или компонентов: 
\begin{enumerate}
\item датчика температуры DS18B20;
\item микроконтроллера ESP8266-12E;
\item экрана OLED ($128\times64$ px);
\item стабилизатора напряжения с $5$ В до $3{,}3$ В или блока питания с аккумулятором;
\item резисторов и нажимной кнопки.
\end{enumerate}

Также, для прошивки и программирования микроконтроллера, требуется преобразователь CP2102 USB-UART.

\noindent%
\begin{minipage}{\linewidth}%
\centering
\input{Схемы/Схема цифрового термометра}
\captionof{figure}{Схема компонентов прибора цифрового термометра.}
\label{Прибор}
\vspace{4mm}
\end{minipage}

На рис.~\ref{Прибор} показаны компоненты прибора цифрового термометра и их соединения. Стабилизатор напряжения получает $5$ В, например от источника питания порта USB, и преобразует в напряжение в $3{,}3$ В, от которого питаются все остальные компоненты прибора, контакты 1 и 2. Стабилизатор можно заменить аккумуляторным блоком питания, который описывается ниже в подподразделе \ref{Аккумуляторный блок питания}.

Для запуска микроконтроллера ножка CH\_PD связывается через резистор $10$ кОм с напряжением $3{,}3$ В, ножка GPIO13 связывается с напряжением $3{,}3$ В, ножка GPIO15 связывается с землей и ножка GPIO02 связывается через резистор $10$ кОм с землей. 

Микроконтроллер соединяется с выводом DATA датчика температуры через ножку GPIO05. Вывод DATA датчика температуры связывается с напряжением $3{,}3$ V резистором $4{,}7$ кОм. Микроконтроллер связывается с ножкой SCL экрана через ножку GPIO04, с ножкой SDA экрана через ножку GPIO00. %Нажимная кнопка подает положительный сигнал на ножку GPIO12 микроконтроллера, которая связывается резистором $10$ кОм с землей. 
Нажимная кнопка подает отрицательный сигнал на ножку GPIO12 микроконтроллера.

\subsubsection{Аккумуляторный блок питания}\label{Аккумуляторный блок питания}

Для того, чтобы устройство было автономным в плане энергии, вместо стабилизатора напряжение можно использовать аккумуляторный блок питания.

Аккумуляторный блок питания состоит из следующих трёх компонентов:
\begin{enumerate}
    \item литий-полимерного аккумулятора с номинальным напряжением $3{,}7$ В;
    \item стабилизатора напряжения TPS63020 с выходным напряжением $3{,}3$ В и диапазоном входного напряжения $1{,}8-5$ В;
    \item модуль зарядки аккумулятора TP4056 (входное напряжение $5$ В от USB, максимальный заряд напряжения батареи $4{,}2$ В).
\end{enumerate}

\noindent%
\begin{minipage}{\linewidth}%
\vspace{0.5cm}
\centering
\input{Схемы/Схема аккумуляторного блока питания}
\captionof{figure}{Схема компонентов аккумуляторного блока питания.}
\label{Блок питаня аккумулятора}
\vspace{4mm}
\end{minipage}

На рис.~\ref{Блок питаня аккумулятора} показаны компоненты аккумуляторного блока питания и их соединения. Модуль зарядки получает внешнее питание ($5$ В) от порта USB. Выход модуля зарядки соединен с аккумулятором и входом стабилизатора напряжения.

Вход стабилизатора напряжения получает напряжение в диапазоне от $1{,}8$ В до $5$ В и преобразует его, повышая или понижая, в $3{,}3$ В на своем выходе. Выход стабилизатора напряжения соединяется с контактами 1 и 2 рис.~\ref{Прибор}, через которые запитывает прибор. 

При подключении внешнего питания к модулю зарядки, модуль начинает заряжать батарею и одновременно питать стабилизатор напряжения. Когда батарея заряжена и модуль зарядки отключен от внешнего питания, то стабилизатор напряжения питает батарея.

В случае, если ёмкость батареи $1800$ мА час, то полного заряда хватает на 7 часов работы прибора.

\subsection{Программная часть}\label{Программная часть}


Программная часть касается программирования микроконтроллера. Микроконтроллер использует платформу Espruino, которая предоставляет среду выполнения JavaScript-кода.

%\noindent%
%\begin{minipage}{\linewidth}%
%	\input{Схемы/Схема алгоритма прибора}
%	\captionof{figure}{Блок-схема алгоритма прибора.}
%	\label{Алгоритм прибора}
%	\vspace{4mm}
%\end{minipage}


\begin{figure}[p]
    \centering
	\input{Схемы/Схема алгоритма прибора}
	\captionof{figure}{Блок-схема алгоритма прибора.}
	\label{Алгоритм прибора}
\end{figure}

На рис.~\ref{Алгоритм прибора} показан алгоритм программной части. Прибор может находится в двух режимах: ожидания и опыта. %При запуске микроконтроллер устанавливает режим ожидания (присваивается значение ожидания переменной «режим»). Далее в микроконтроллере можно рассмотреть следующие потоки:
При запуске микроконтроллер считывает значение режима из хранилища и, в случае, если значение равно «опыт», то устанавливает режим опыта. Иначе устанавливает режим ожидания. Установление режима означает присваивание  соответствующего значения переменной «режим». Далее в микроконтроллере можно рассмотреть следующие потоки:
\begin{itemize}
	\item Подключение микроконтроллера к сети WIFI.
	\item Соединение микроконтроллера с датчиком температуры.
	\item Соединение микроконтроллера с экраном.
\end{itemize}
После подключения к экрану запускаются два дополнительных потока: 
\begin{itemize}
	\item Первый поток касается ежесекундного считывания температуры.
	\item Второй поток касается отслеживания нажатия кнопки.
\end{itemize}



В потоке подключения к сети WIFI присваиваются значения переменным 'con\-nected', 'error' и 'IP'. Данные подключения к сети WIFI, т.~е. название точки доступа и пароль, прописаны в самом коде. Переменная 'connected' содержит логическое значение и при успешном подключении к сети принимает значение истинности. Переменная 'error' содержит строку ошибки в случае ошибки подключения. Переменная 'IP' содержит строку с адресом IP, который получил прибор при успешном подключении к сети. Эти переменные используются в потоке ежесекундного считывания температуры. 
%На экране в верхней строке отображается успешное подключение к сети и адрес IP прибора, или же строка ошибки подключения к сети.

%var ow = new OneWire(D5);
%var sensor = require("DS18B20").connect(ow);
%OneWire (однопроводной интерфейс) - это протокол связи, позволяющий управлять устройствами через один провод, что делает его очень удобным для использования в ограниченных по ресурсам системах, таких как микроконтроллеры

В потоке соединения с датчиком температуры микроконтроллер подключается к ножке GPIO05, используя протокол OneWire (однопроводной интерфейс). При успешном подключении, поток сливается с потоком соединения с экраном и переходит в поток ежесекундного считывания температуры.

%I2C1.setup({scl:D4,sda:D0});
%g = require("SSD1306").connect(I2C1, start);
%I2C (Inter-Integrated Circuit) - это последовательный двунаправленный протокол связи, который позволяет микроконтроллеру взаимодействовать с другими устройствами, такими как сенсоры, EEPROM, акселерометры и другие микроконтроллеры, посредством передачи данных через два провода: линию данных (SDA) и линию тактирования (SCL).
Микроконтроллер соединяется с экраном, используя протокол I2C (Inter-Integra\-ted Circuit), подключая линию данных (SDA) экрана к ножке GPIO00, а линию тактирования (SCL) экрана к ножке GPIO04. При успешном подключении, поток сливается с потоком соединения с датчиком температуры и переходит в поток ежесекундного считывания температуры.

В потоке ежесекундного считывания температуры микроконтроллер с интервалом в одну секунду считывает информацию с датчика температуры. Далее, микроконтроллер отображает на экране считанную температуру, переменные потока подключения к сети WIFI, а также режим опыта. Температура отображается крупным шрифтом в центре экрана. Переменные подключения к сети WIFI отображаются в начале верхней строки: успешное подключение к сети и адрес IP прибора, или же строка ошибки подключения к сети. Режим опыта отображается в конце верхней строки словом "Op". Если микроконтроллер находится в режиме опыта, то он посылает запрос на сервис с текущей температурой. Таким образом, в режиме опыта микроконтроллер ежесекундно посылает запрос на сервис с текущей температурой. Ссылка на сервис HTTP прописана в коде.

В потоке отслеживания нажатия кнопки микроконтроллер отслеживает отрицательный сигнал на ножке GPIO12. Для этого он устанавливает ножку в режиме input pullup и прерывание (watch). При нажатии кнопки, на ножку поступает отрицательный сигнал и срабатывает прерывание. Для избежания ложных срабатываний прерывания, например при дребезге контактов кнопки, указывается параметр "debounce".  %используя переменную «пред» и текущее время, сравнивается, прошло ли больше 1 миллисекунды с момента последнего нажатия кнопки.
Далее, рассматриваем не ложное прерывание. Когда микроконтроллер находится в режиме опыта, то он устанавливает режим ожидания. Когда микроконтроллер находится в режиме ожидания, то он посылает запрос «Новый опыт» на сервис и устанавливает режим опыта. В этих случаях установление режима означает не только присваивание соответствующего значения переменной «режим», но и запись этого значения в хранилище.  Таким образом, нажатие кнопки является интерфейсом для переключения режима прибора с ожидания на опыт и наоборот.



\section{Сервис HTTP}\label{Сервис HTTP}

Сервис написан на языке Python и реализует простой сервис HTTP, в котором обрабатываются два запроса типа GET: «Текущая температура» и «Новый опыт».

Сервис запускается функцией 'run', которая принимает аргументы 'server\-Class' и 'handlerClass'. По умолчанию аргумент 'serverClass' имеет значение 'HTTPServer', а аргумент 'handlerClass' имеет значение 'Base\-HTTP\-Request\-Handler'. Сервис обрабатывает запросы с порта, который указывается в коде.

Для того, чтобы обрабатывать полученные запросы, сервис расширяет класс 'BaseHTTPRequestHandler' классом 'HttpGetHandler', в котором, в методе 'doGET', реализуется обработка запросов типа GET. Метод 'doGET' обрабатывает полученные запросы, выделяя из них необходимые параметры «температура» или «опыт». Если в запросе присутствует параметр «опыт», то выполняется метод 'novijOpyt'. Иначе, если в запросе присутствует параметр «температура», то выполняется метод 'pishiOpyt'.

Метод 'novijOpyt' создает архив, в названии которого присутствуют текущее дата и время, и создает в этом архиве два столбца: время и температура, разделенные символом табуляра. 

Метод 'pishiOpyt' записывает в созданный ранее архив время получения запроса и полученную температуру в соответствующие столбцы.

\section{Установка}\label{Установка}

\subsection{Прошивка прибора}\label{Прошивка прибора}

Для того, чтобы прошить и запрограммировать микроконтроллер, нужно подсоединить к микроконтроллеру преобразователь CP2102. На рис.~\ref{Прошивка} показана схема подключения преобразователя с микроконтроллером. Преобразователь подключается через USB кабель с компьютером, c которого будет осуществляться прошивка и программирование микроконтроллера.

\noindent%
\begin{minipage}{\linewidth}% 
\vspace{0.5cm}
\centering
	\input{Схемы/Схема подключения преобразователя USB}
	\captionof{figure}{Схема подключения преобразователя USB для прошивки.}
	\label{Прошивка}
	\vspace{4mm}
\end{minipage}

Программа микроконтроллера написана на языке JavaScript и работает через платформу Espruino. Это значит, что на микроконтроллере должна присутствовать прошивка платформы Espruino (espruino 2v21). 

Чтобы установить платформу Espruino на микроконтроллер, понадобится следующее:
\begin{itemize}
	\item компьютер с операционной системой Windows 10,
	\item архив с прошивкой платформы Espruino (\texttt{'espruino\_2v21.zip'}),
	\item интерпретатор Python (версия 3.8.9),
	\item архив с драйвером преобразователя (\texttt{'CP210x\_Universal\_Windows\_\-Driver.zip'}).
\end{itemize}

Далее следует пошаговая инструкция:
\begin{enumerate}
	\item Скачиваем нужные архивы на компьютер.
	\item Устанавливаем на компьютер драйвер преобразователя из архива \texttt{'CP210x\_\-Universal\_\-Windows\_\-Driver.zip'}.
	\item Устанавливаем на компьютер Python (если он не установлен).
	\item Устанавливаем на компьютер модуль питона "esptool"\ командой:
	\begin{minted}{shell-session}
pip install esptool 
	\end{minted}

	\item Распаковываем прошивку платформы Espruino в какую-нибудь папку на компьютере (например в папку \texttt{c:\textbackslash espruino\textbackslash}).
	\item Подключаем компьютер к преобразователю (через USB кабель). В диспетчере устройств на компьютере в портах (COM и LTP) следует обнаружить порт подключения (например COM6).
	\item На микроконтроллере замыкаем ножку GPIO00 с землей.
	\item На компьютере через командую строку переходим в подпапку \texttt{"espruino\-\_2v21\-\_esp8266\_4mb"\ } папки, куда распаковали прошивку платформы Espruino, и задаём следующую команду:
	\begin{minted}{shell-session}
c:\espruino\espruino_2v21_esp8266_4mb>esptool --port COM6 --baud 460800 write_flash --flash_freq 80m --flash_mode qio --flash_size 4MB-c1 0x0000 boot_v1.6.bin 0x1000 espruino_esp8266_user1.bin 0x3FC000 esp_init_data_default.bin 0x3FE000 blank.bin 
	\end{minted}
Результат команды должен выглядеть следующим образом:
\begin{minted}[frame=lines,
	framesep=1mm,
	baselinestretch=1.1,
	bgcolor=LightGray,
	fontsize=\tiny]{shell-session}
esptool.py v4.7.0
Serial port COM6
Connecting....
Detecting chip type... Unsupported detection protocol, switching and trying again...
Connecting...
Detecting chip type... ESP8266
Chip is ESP8266EX
Features: WiFi
Crystal is 26MHz
MAC: 58:bf:25:d7:5c:89
Uploading stub...
Running stub...
Stub running...
Changing baud rate to 460800
Changed.
Configuring flash size...
Flash will be erased from 0x00000000 to 0x00000fff...
Flash will be erased from 0x00001000 to 0x0008dfff...
Flash will be erased from 0x003fc000 to 0x003fcfff...
Flash will be erased from 0x003fe000 to 0x003fefff...
Flash params set to 0x006f
Compressed 3856 bytes to 2763...
Wrote 3856 bytes (2763 compressed) at 0x00000000 in 0.1 seconds (effective 254.1 kbit/s)...
Hash of data verified.
Compressed 577188 bytes to 369191...
Wrote 577188 bytes (369191 compressed) at 0x00001000 in 9.3 seconds (effective 496.7 kbit/s)...
Hash of data verified.
Compressed 128 bytes to 75...
Wrote 128 bytes (75 compressed) at 0x003fc000 in 0.1 seconds (effective 18.4 kbit/s)...
Hash of data verified.
Compressed 4096 bytes to 26...
Wrote 4096 bytes (26 compressed) at 0x003fe000 in 0.1 seconds (effective 633.4 kbit/s)...
Hash of data verified.
\end{minted}
\end{enumerate}

Таким образом мы прошили микроконтроллер прошивкой платформы Espruino.

%http://www.espruino.com/files/espruino_2v21.zip, разорхивировать папку espruino и перейти в подпапку espruino_2v21_esp8266_4mb.
%d:\Maxim\Desktop\espruino\espruino_2v21_esp8266_4mb>esptool --port COM6 --baud 460800 write_flash --flash_freq 80m --flash_mode qio --flash_size 4MB-c1 0x0000 boot_v1.6.bin 0x1000 espruino_esp8266_user1.bin 0x3FC000 esp_init_data_default.bin 0x3FE000 blank.bin


Чтобы запрограммировать микроконтроллер, понадобится среда Espruino Web IDE, которую следует установить на компьютер. Запускаем среду, открываем архив с программным кодом, подключаемся к микроконтроллеру (предварительно подключив компьютер к преобразователю через USB кабель) и посылаем программный код на микроконтроллер. При успешной прошивке прибор постарается подключиться к беспроводной сети WIFI, а при нажатии на кнопку отослать запрос на сервис. Данные подключения к сети и ссылки на сервис необходимо изменить в начале программного кода прошивки, где они выражены переменными WIFI\_NAME, WIFI\_OPTIONS и serviceHost соответственно.


\subsection{Запуск сервиса}\label{Запуск сервиса}

Сервис запускается на сервере. На сервере необходимо установить интерпретатор Python версии 3 (если он не установлен). Установка сервиса -- это помещение кода сервиса, архив \texttt{'Сервис HTTP.py'}, в какую-нибудь папку на сервере, в которой пользователь имеет доступ записи. 

Запуск сервиса осуществляется следующей командой:
\begin{minted}{shell-session}
python "Сервис HTTP.py"
\end{minted}
Сервис работает постоянно, т.~е. запуск сервиса не заканчивается, если его не закончить принудительно. Сервис создает и записывает архивы опытов в папку, из которой он запущен.

\section{Заключение}\label{Заключение}

В этом документе описываются способ создания прибора «Цифровой термометр». Прибор можно использовать в лабораторных физических опытах, таких как кристаллизация и плавление жидкостей, в частности воды. У прибора выносной термометр, позволяющий поместить его в жидкость, заморозить вместе с жидкостью и, подключив термометр к прибору, провести опыт плавления. Так как прибор может питаться от аккумулятора, его можно поместить в морозильную камеру и провести опыт кристаллизации. Данные, собранные прибором, можно использовать для построения графиков изменения температуры во времени.

Прибор можно усовершенствовать, добавив ему функционал режима настройки данных подключения к сети WIFI и ссылки на сервис. Этого можно достичь следующим образом: при включении прибора и одновременном нажатии на кнопку устанавливать микроконтроллер в режиме точки доступа беспроводной сети WIFI. В этом режиме микроконтроллер будет выполнять роль сервиса HTTP и предостовлять страницу с формой настроек. В таком режиме пользователь подключается к точке доступа (без пароля), переходит на страницу с формой настроек и указывает настройки. Также можно добавить настройку интервала периодического считывания температуры или интервала отправки запроса.


\end{document}